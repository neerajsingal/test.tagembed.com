var ApplicationDisplayEmbed = ApplicationDisplayEmbed || function (w, u) {
    var wallObject = {},
        iframeModalObject = null,
        backlinkObject = null,
        iframeModalLoaded = false,
        AppPath = "https://app.taggbox.com/display/";
    var loading = true;
    var receiveMessage = function (event) {
        var dataObject;
        if (typeof event.data == 'string') {
            try {
                dataObject = JSON.parse(event.data);
            } catch (e) {
                item = {}
                item["type"] = '';
                dataObject = item;
            }
        }
        else {
            dataObject = event.data;
        }

        switch (dataObject.type) {
            case 'getHeight':

                for (var i in wallObject) {
                    if (wallObject[i].id == dataObject.data.iframe) {
                        var fixedHeight = parseInt(wallObject[i].getAttribute('data-fixed-height'));
                        if (fixedHeight == 1) {
                            wallObject[i].parentElement.parentElement.style.height = dataObject.data.height + 'px';
                            wallObject[i].style.height = dataObject.data.height + 'px';
                            wallObject[i].style.minHeight = dataObject.data.height + 'px';
                        }
                    }
                }

                break;
            default:
                break;
        }
    }
    return {
        init: function () {
            var count = 0;
            for (var prop in wallObject) {
                if (wallObject.hasOwnProperty(prop))
                    ++count;
            }
            if (count == 0) {
                window.addEventListener("message", receiveMessage, false);
            }
            //var container = document.querySelector('.taggbox-socialwall');
            var parentContainer = document.getElementsByClassName('taggbox-container');

            for (var i = 0; i < parentContainer.length; i++) {
                var divWidth = parentContainer[i].clientWidth;
                if (divWidth >= window.innerWidth) {
                    parentContainer[i].style.width = '100%'
                }
                parentContainer[i].style.lineHeight = 'initial';
                parentContainer[i].style.overflow = 'hidden';
                var styleElement = document.createElement("style");
                //styleElement.appendChild(document.createTextNode(".taggbox-container::-webkit-scrollbar {-webkit-appearance: none;width: 3px;} .taggbox-container::-webkit-scrollbar-thumb {border-radius: 4px;background-color: rgba(0,0,0,.5); .taggbox-container::-webkit-box-shadow: 0 0 1px rgba(255,255,255,.5);}"));
                //styleElement.appendChild(document.createTextNode(".taggbox-container::-webkit-scrollbar {-webkit-appearance: none;width: 3px;} .taggbox-container::-webkit-scrollbar-thumb {border-radius: 4px;background-color: rgba(0,0,0,.5);-webkit-box-shadow: 0 0 1px rgba(255,255,255,.5);} .taggbox-container::-webkit-scrollbar-track{ box-shadow: inset 0 0 6px rgba(0,0,0,0.3);-moz-box-shadow:inset 0 0 6px rgba(0,0,0,0.3);-webkit-box-shadow: inset 0 0 6px rgba(0,0,0,0.3);background-color: #f9f9f9;border-radius:3px;-moz-border-radius:3px;-webkit-border-radius:3px;}"));
                parentContainer[i].appendChild(styleElement);
            }
            var container = document.getElementsByClassName('taggbox-socialwall');

            var iframe;
            for (var i = 0; i < container.length; i++) {
                iframe = container[i].getElementsByTagName("iframe");
                if (iframe.length == 0) {
                    var fixedHeight = 1;
                    var iframeHeight = 300;

                    var containerHeight = container[i].parentElement.style.height;
                    containerHeight = parseInt(containerHeight.replace(/[^\d.-]/g, ''));

                    if (containerHeight > 100) {
                        fixedHeight = 0;
                        iframeHeight = containerHeight;
                    }
                    var wallKey = "";
                    var viewUrl = container[i].getAttribute("view-url");
                    var viewUrlWallKey = new URL(viewUrl);
                    if (viewUrlWallKey.searchParams.has("wallKey") && viewUrlWallKey.searchParams.get("wallKey") && viewUrlWallKey.searchParams.get("wallKey").length > 0) {
                        wallKey = `&wallKey=${viewUrlWallKey.searchParams.get("wallKey")}`
                    }

                    var wallUrl = container[i].getAttribute("data-wall-id") + '/editor/1';
                    var frameUrl = '?webembed=1' + wallKey;
                    var r = Math.random().toString(36).substring(7);
                    var iframeElem = '<iframe src="https://display.taggbox.com/' + wallUrl + frameUrl + '" data-fixed-height="' + fixedHeight + '" data-height="' + iframeHeight + '" data-wall="' + wallUrl + '" data-position="' + i + '" id="iframe' + r + '" style="visibility: hidden;position: absolute;margin:0;left: -999em;display: inline-block;border: none;width:100%;height:300px;" scrolling="no" frameborder="0" allowtransparency="true" title="Taggbox widget"></iframe>';
                    container[i].innerHTML = iframeElem;
                    container[i].style.webkitOverflowScrolling = "touch";
                    try {
                        /*console.log(container[i].parentElement);*/
                        container[i].parentElement.style.webkitOverflowScrolling = "touch";
                    } catch (err) {
                        console.log('a');
                    }

                    iframeElem = container[i].firstChild;
                    wallObject[i] = iframeElem;
                    document.getElementById('iframe' + r).addEventListener("load", function () {

                        var zIndex = this.getAttribute('data-position');
                        var iframeId = this.getAttribute('id');
                        var fixedHeight = this.getAttribute('data-fixed-height');
                        var iframeHeight = this.getAttribute('data-height');
                        /*iframeElem.style.display = 'block';*/
                        this.style.visibility = 'visible';
                        this.style.position = 'static';
                        var parentContainerHeight = parentContainer[zIndex].offsetHeight;
                        this.style.minHeight = parentContainerHeight + 'px';
                        
                        //document.getElementById('_taggbox_modal_frame_loader_'+iframeId).style.display = 'none';
                        var myurl = window.location.href;
                        var obj = {
                            type: 'startEmbed',
                            url: myurl,
                            id: iframeId,
                            fixedHeight: fixedHeight,
                            iframeHeight: iframeHeight
                        };

                        this.contentWindow.postMessage(obj, this.src);

                    });
                    window.addEventListener('message', function (e) {
                        var scroll_height = e.data;
                        document.getElementById('iframe' + r).style.height = scroll_height + 'px';
                    }, false);
                }
            }

        }
    };
}(window, undefined);
ApplicationDisplayEmbed.init();